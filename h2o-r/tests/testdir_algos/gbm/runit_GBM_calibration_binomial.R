setwd(normalizePath(dirname(R.utils::commandArgs(asValues=TRUE)$"f")))
source("../../../scripts/h2o-r-test-setup.R")



test.GBM.calibration.binomial <- function() {

    ecology.hex <- h2o.importFile(locate("smalldata/gbm_test/ecology_model.csv"))
    ecology.hex$Angaus <- as.factor(ecology.hex$Angaus)

    ecology.split <- h2o.splitFrame(ecology.hex, seed = 12354)
    ecology.train <- ecology.split[[1]]
    ecology.calib <- ecology.split[[2]]

    # Train H2O GBM Model with Calibration
    ecology.model <- h2o.gbm(x = 3:13, y = "Angaus", training_frame = ecology.train,
                             ntrees = 10,
                             max_depth = 5,
                             min_rows = 10,
                             learn_rate = 0.1,
                             distribution = "multinomial",
                             calibrate_model = TRUE,
                             calibration_frame = ecology.calib
    )

    predicted <- h2o.predict(ecology.model, ecology.calib)

    # Check that calibrated probabilities were appended to the output frame
    expect_equal(colnames(predicted), c("predict", "p0", "p1", "cal_p0", "cal_p1"))

    # Manually scale the probabilities using GLM in R
    manual.calib.input <- cbind(as.data.frame(predicted$p1), as.data.frame(ecology.calib$Angaus))
    colnames(manual.calib.input) <- c("x", "y")
    manual.calib.model <- glm(y ~ x, manual.calib.input, family = binomial)
    manual.calib.predicted <- predict(manual.calib.model, newdata = manual.calib.input, type = "response")

    # Check that manually calculated probabilities match output from H2O
    expect_equal(
        as.data.frame(predicted$cal_p1),
        data.frame(cal_p1 = manual.calib.predicted, row.names = NULL),
        tolerance = 1e-3, scale = 1
    )
}

doTest("GBM: Test Binomial Model Calibration (Platt Scaling)", test.GBM.calibration.binomial)

